name: 📱 Análisis Avanzado APK++

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: '🗂️ Nombre del archivo APK (ej: app.apk)'
        required: true
        default: 'app.apk'
        type: string

jobs:
  analisis_completo:
    name: 🔍 Auditoría con ApkTool + JADX
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Clonar repositorio
        uses: actions/checkout@v4

      - name: ⚙️ Instalar dependencias
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq apktool wget unzip curl jq openjdk-17-jdk python3-pip
          pip install --quiet semgrep mobsfscan
          # Instalar JADX
          wget -q https://github.com/skylot/jadx/releases/download/v1.4.8/jadx-1.4.8.zip
          unzip -q jadx-1.4.8.zip -d jadx

      - name: 📦 Preparar entorno
        run: |
          mkdir -p decompilado/jadx
          mkdir -p decompilado/apktool

      - name: 🛠️ Decompilar con ApkTool
        run: apktool d "${{ inputs.apk_name }}" -o decompilado/apktool -f

      - name: 🛠️ Decompilar con JADX
        run: ./jadx/bin/jadx -d decompilado/jadx "${{ inputs.apk_name }}" || echo "⚠️ JADX falló (pero ApkTool OK)"

      - name: 🧪 Iniciar resumen
        run: echo "📄 Resumen combinado de '${{ inputs.apk_name }}'" > resumen_apk.txt

      - name: 🔐 Permisos críticos y componentes exportados
        run: |
          echo -e "\n🔐 Permisos y exportados:" >> resumen_apk.txt
          grep -i "uses-permission" decompilado/apktool/AndroidManifest.xml | \
          grep -Ei "INTERNET|SMS|READ_CONTACTS|CALL_PHONE|CAMERA|RECORD_AUDIO|ACCESS_FINE_LOCATION|WRITE_SETTINGS" \
          >> resumen_apk.txt || echo "✔️ No se detectaron permisos críticos" >> resumen_apk.txt
          grep -iE 'android:exported="true"' decompilado/apktool/AndroidManifest.xml >> resumen_apk.txt || echo "✔️ Sin componentes exportados inseguros" >> resumen_apk.txt

      - name: 🌐 URLs y endpoints
        run: |
          echo -e "\n🌐 URLs encontradas:" >> resumen_apk.txt
          grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' decompilado/ | sort -u >> resumen_apk.txt || echo "✔️ No se encontraron URLs" >> resumen_apk.txt

      - name: 🐍 TruffleHog (Secrets)
        run: |
          echo -e "\n🐍 TruffleHog:" >> resumen_apk.txt
          wget -q https://github.com/trufflesecurity/trufflehog/releases/download/v3.71.0/trufflehog_3.71.0_linux_amd64.tar.gz
          tar -xzf trufflehog_3.71.0_linux_amd64.tar.gz
          ./trufflehog filesystem --directory decompilado --no-verification --json > trufflehog.json || true
          jq -r '.results[]? | .SourceMetadata.Data.Git.file + ": " + .Raw' trufflehog.json >> resumen_apk.txt || echo "✔️ No se detectaron secretos" >> resumen_apk.txt

      - name: 🔐 Gitleaks
        run: |
          echo -e "\n🔐 Gitleaks:" >> resumen_apk.txt
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          ./gitleaks detect --source decompilado --no-git -v --report-format=json --report-path=gitleaks.json || true
          jq -r '.[]? | .File + ": " + .Secret' gitleaks.json >> resumen_apk.txt || echo "✔️ No se detectaron secretos con Gitleaks" >> resumen_apk.txt

      - name: 🛡️ Semgrep + MobSFScan
        run: |
          echo -e "\n🛡️ Semgrep:" >> resumen_apk.txt
          semgrep --quiet --config "p/mobsfscan" decompilado/ --json > semgrep.json || true
          jq -r '.results[]? | .path + ": " + .extra.message' semgrep.json >> resumen_apk.txt || echo "✔️ No hallazgos Semgrep" >> resumen_apk.txt

          echo -e "\n📱 MobSFScan:" >> resumen_apk.txt
          mobsfscan --severity-threshold low decompilado/ --json > mobsfscan.json || true
          jq -r '.results[]? | .file_path + ": " + .title' mobsfscan.json >> resumen_apk.txt || echo "✔️ No hallazgos MobSFScan" >> resumen_apk.txt

      - name: 📄 Mostrar resumen
        run: |
          echo -e "\n📋 RESUMEN FINAL:"
          cat resumen_apk.txt

      - name: 💾 Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: resumen-avanzado-apk
          path: |
            resumen_apk.txt
            trufflehog.json
            gitleaks.json
            semgrep.json
            mobsfscan.json
