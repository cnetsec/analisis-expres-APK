name: ðŸ“± AnÃ¡lisis Avanzado APK

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: 'ðŸ—‚ï¸ Nombre del archivo APK (ej: app.apk)'
        required: true
        default: 'app.apk'
        type: string

jobs:
  analisis_completo:
    name: ðŸ” AuditorÃ­a Avanzada del APK
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar dependencias necesarias
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq apktool wget unzip curl jq python3-pip openjdk-17-jdk
          pip install --quiet semgrep mobsfscan

      - name: ðŸ“¦ Preparar entorno
        run: mkdir -p decompilado

      - name: ðŸ› ï¸ Decompilar APK
        run: apktool d "${{ inputs.apk_name }}" -o decompilado -f

      - name: ðŸ§ª Iniciar resumen
        run: echo "ðŸ“„ Resumen del anÃ¡lisis avanzado de '${{ inputs.apk_name }}'" > resumen_apk.txt

      - name: ðŸ” Permisos peligrosos y exportaciÃ³n de componentes
        run: |
          echo -e "\nðŸ” Permisos y componentes exportados:" >> resumen_apk.txt
          grep -i "uses-permission" decompilado/AndroidManifest.xml | \
          grep -Ei "INTERNET|SMS|SEND_SMS|RECEIVE_SMS|READ_SMS|READ_CONTACTS|WRITE_CONTACTS|READ_CALL_LOG|WRITE_CALL_LOG|READ_PHONE_STATE|CALL_PHONE|RECORD_AUDIO|CAMERA|ACCESS_FINE_LOCATION|ACCESS_COARSE_LOCATION|SYSTEM_ALERT_WINDOW|WRITE_SETTINGS|READ_EXTERNAL_STORAGE|WRITE_EXTERNAL_STORAGE|INSTALL_PACKAGES|REQUEST_INSTALL_PACKAGES" \
          >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron permisos crÃ­ticos" >> resumen_apk.txt
          grep -iE 'android:exported="true"' decompilado/AndroidManifest.xml >> resumen_apk.txt || echo "âœ”ï¸ No hay componentes exportados inseguros" >> resumen_apk.txt

      - name: âš ï¸ Flags de seguridad
        run: |
          echo -e "\nâš ï¸ Flags de seguridad:" >> resumen_apk.txt
          grep -iE "android:debuggable|allowBackup|usesCleartextTraffic" decompilado/AndroidManifest.xml >> resumen_apk.txt || echo "âœ”ï¸ Flags de seguridad correctas" >> resumen_apk.txt

      - name: ðŸŒ URLs y endpoints
        run: |
          echo -e "\nðŸŒ URLs y endpoints encontrados:" >> resumen_apk.txt
          grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' decompilado/ | sort -u >> resumen_apk.txt || echo "âœ”ï¸ No se encontraron URLs" >> resumen_apk.txt

      - name: ðŸ”‘ Certificado APK
        run: |
          echo -e "\nðŸ”‘ InformaciÃ³n del certificado:" >> resumen_apk.txt
          keytool -printcert -jarfile "${{ inputs.apk_name }}" >> resumen_apk.txt || echo "âš ï¸ No se pudo leer el certificado" >> resumen_apk.txt

      - name: ðŸ›¡ï¸ RevisiÃ³n ProGuard/OfuscaciÃ³n
        run: |
          echo -e "\nðŸ›¡ï¸ RevisiÃ³n de ofuscaciÃ³n:" >> resumen_apk.txt
          [ -f decompilado/proguard.cfg ] && echo "âš ï¸ Se detectÃ³ configuraciÃ³n de ProGuard" >> resumen_apk.txt || echo "â— No se detectÃ³ ProGuard (posible cÃ³digo sin ofuscar)" >> resumen_apk.txt

      - name: ðŸ TruffleHog â€“ HeurÃ­sticas de secretos
        run: |
          echo -e "\nðŸ TruffleHog:" >> resumen_apk.txt
          wget -q https://github.com/trufflesecurity/trufflehog/releases/download/v3.71.0/trufflehog_3.71.0_linux_amd64.tar.gz
          tar -xzf trufflehog_3.71.0_linux_amd64.tar.gz
          ./trufflehog filesystem --directory decompilado --no-verification --json > trufflehog.json || true
          jq -r '.results[]? | .SourceMetadata.Data.Git.file + ": " + .Raw' trufflehog.json >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron secretos con TruffleHog" >> resumen_apk.txt

      - name: ðŸ” Gitleaks â€“ Credenciales
        run: |
          echo -e "\nðŸ” Gitleaks:" >> resumen_apk.txt
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          ./gitleaks detect --source decompilado --no-git -v --report-format=json --report-path=gitleaks.json || true
          jq -r '.[] | .File + ": " + .Secret' gitleaks.json >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron secretos con Gitleaks" >> resumen_apk.txt

      - name: ðŸ›¡ï¸ Semgrep â€“ Reglas Android
        run: |
          echo -e "\nðŸ›¡ï¸ Semgrep:" >> resumen_apk.txt
          semgrep --quiet --config "p/mobsfscan" decompilado/ --json > semgrep.json || true
          jq -r '.results[]? | .path + ": " + .extra.message' semgrep.json >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron problemas con Semgrep" >> resumen_apk.txt

      - name: ðŸ“± MobSFScan â€“ AuditorÃ­a completa
        run: |
          echo -e "\nðŸ“± MobSFScan:" >> resumen_apk.txt
          mobsfscan decompilado/ --json > mobsfscan.json || true
          jq -r '.results[]? | .file_path + ": " + .title' mobsfscan.json >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron hallazgos con MobSFScan" >> resumen_apk.txt

      - name: ðŸ“„ Mostrar resumen en pantalla
        run: |
          echo -e "\nðŸ“‹ RESUMEN FINAL:"
          cat resumen_apk.txt

      - name: ðŸ’¾ Subir artefactos de resultados
        uses: actions/upload-artifact@v4
        with:
          name: resumen-avanzado-apk
          path: |
            resumen_apk.txt
            trufflehog.json
            gitleaks.json
            semgrep.json
            mobsfscan.json
