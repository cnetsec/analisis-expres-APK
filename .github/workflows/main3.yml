name: ðŸ“± AnÃ¡lisis Avanzado APK

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: 'ðŸ—‚ï¸ Nombre del archivo APK (ej: app.apk)'
        required: true
        default: 'app.apk'
        type: string

jobs:
  analisis_completo:
    name: ðŸ” AuditorÃ­a Avanzada del APK
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Preparar entorno
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq apktool wget unzip curl jq python3-pip openjdk-17-jdk
          pip install --quiet semgrep mobsfscan
          wget -q https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
          unzip -q jadx-1.4.7.zip -d jadx
          chmod +x jadx/bin/jadx

      - name: ðŸ“¦ Preparar directorios
        run: mkdir -p decompilado jadx_out

      - name: ðŸ› ï¸ Decompilar APK (ApkTool + JADX)
        run: |
          apktool d "${{ inputs.apk_name }}" -o decompilado -f
          ./jadx/bin/jadx -d jadx_out "${{ inputs.apk_name }}" || echo "âš ï¸ JADX fallÃ³, continuando solo con ApkTool"

      # =======================
      # 1. ANÃLISIS APKTOOL
      # =======================
      - name: ðŸ“„ AnÃ¡lisis con ApkTool
        run: |
          echo "ðŸ“„ Resultados de ApkTool para '${{ inputs.apk_name }}'" > apktool_findings.txt
          echo -e "\nðŸ” Permisos peligrosos y componentes exportados:" >> apktool_findings.txt
          grep -i "uses-permission" decompilado/AndroidManifest.xml | grep -Ei "INTERNET|SMS|READ_CONTACTS|CAMERA|RECORD_AUDIO|ACCESS_FINE_LOCATION" >> apktool_findings.txt || echo "âœ”ï¸ Sin permisos crÃ­ticos" >> apktool_findings.txt
          grep -iE 'android:exported="true"' decompilado/AndroidManifest.xml >> apktool_findings.txt || echo "âœ”ï¸ Sin componentes exportados inseguros" >> apktool_findings.txt
          echo -e "\nâš ï¸ Flags inseguras:" >> apktool_findings.txt
          grep -iE "android:debuggable|allowBackup|usesCleartextTraffic" decompilado/AndroidManifest.xml >> apktool_findings.txt || echo "âœ”ï¸ Flags seguras" >> apktool_findings.txt
          echo -e "\nðŸŒ URLs encontradas:" >> apktool_findings.txt
          grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' decompilado/ | sort -u >> apktool_findings.txt || echo "âœ”ï¸ Sin URLs encontradas" >> apktool_findings.txt
          echo -e "\nðŸ”‘ Certificado:" >> apktool_findings.txt
          keytool -printcert -jarfile "${{ inputs.apk_name }}" >> apktool_findings.txt || echo "âš ï¸ Certificado no leÃ­do" >> apktool_findings.txt
          echo -e "\nðŸ›¡ï¸ RevisiÃ³n de ofuscaciÃ³n:" >> apktool_findings.txt
          [ -f decompilado/proguard.cfg ] && echo "âš ï¸ Se detectÃ³ configuraciÃ³n ProGuard" >> apktool_findings.txt || echo "â— CÃ³digo posiblemente sin ofuscar" >> apktool_findings.txt

      # =======================
      # 2. ANÃLISIS JADX
      # =======================
      - name: ðŸ“„ AnÃ¡lisis con JADX
        run: |
          echo "ðŸ“„ Resultados de JADX para '${{ inputs.apk_name }}'" > jadx_findings.txt
          echo -e "\nðŸ§© Posibles secretos en cÃ³digo Java:" >> jadx_findings.txt
          grep -IorE "(apikey|secret|token|password|bearer|auth|authorization|client_id|jwt)[\"'=:\s]+[a-zA-Z0-9_\-]{8,}" jadx_out/ | sort -u >> jadx_findings.txt || echo "âœ”ï¸ Sin secretos detectados" >> jadx_findings.txt

      # =======================
      # 3. HERRAMIENTAS AVANZADAS
      # =======================
      - name: ðŸ TruffleHog â€“ HeurÃ­sticas
        run: |
          wget -q https://github.com/trufflesecurity/trufflehog/releases/download/v3.71.0/trufflehog_3.71.0_linux_amd64.tar.gz
          tar -xzf trufflehog_3.71.0_linux_amd64.tar.gz
          ./trufflehog filesystem --directory decompilado --no-verification --json > trufflehog.json || true

      - name: ðŸ” Gitleaks â€“ Credenciales
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          ./gitleaks detect --source decompilado --no-git -v --report-format=json --report-path=gitleaks.json || true

      - name: ðŸ›¡ï¸ Semgrep â€“ Reglas Android
        run: semgrep --quiet --config "p/mobsfscan" decompilado/ --json > semgrep.json || true

      - name: ðŸ“± MobSFScan â€“ AuditorÃ­a completa
        run: mobsfscan decompilado/ --json > mobsfscan.json || true

      # =======================
      # 4. RESUMEN CONSOLIDADO
      # =======================
      - name: ðŸ“„ Crear resumen consolidado
        run: |
          echo "ðŸ“‹ RESUMEN FINAL DE '${{ inputs.apk_name }}'" > resumen_apk.txt
          echo -e "\n===== RESULTADOS APKTOOL =====\n" >> resumen_apk.txt
          cat apktool_findings.txt >> resumen_apk.txt
          echo -e "\n===== RESULTADOS JADX =====\n" >> resumen_apk.txt
          cat jadx_findings.txt >> resumen_apk.txt
          echo -e "\n===== HERRAMIENTAS AVANZADAS =====" >> resumen_apk.txt
          echo "TruffleHog, Gitleaks, Semgrep y MobSFScan disponibles en JSON para revisiÃ³n detallada." >> resumen_apk.txt

      - name: ðŸ“„ Mostrar resumen en pantalla
        run: cat resumen_apk.txt

      - name: ðŸ’¾ Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: analisis-avanzado-apk
          path: |
            resumen_apk.txt
            apktool_findings.txt
            jadx_findings.txt
            trufflehog.json
            gitleaks.json
            semgrep.json
            mobsfscan.json
