version: 2.1

jobs:
  analisis_completo:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: ðŸ“‚ Verificar existencia del APK
          command: |
            APK_NAME="app.apk"
            echo "ðŸ” Buscando el archivo APK '${APK_NAME}'..."
            if [ ! -f "${APK_NAME}" ]; then
              echo "âŒ APK no encontrado en el repositorio."
              exit 1
            fi
            echo "âœ… APK '${APK_NAME}' encontrado."

      - run:
          name: ðŸ›  Instalar dependencias
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y -qq openjdk-17-jdk unzip wget python3 python3-pip jq
            wget -q https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
            unzip -o jadx-1.4.7.zip -d /opt/jadx
            pip3 install --quiet semgrep mobsfscan

      - run:
          name: ðŸ§© Decompilar APK (JADX)
          command: |
            mkdir -p jadx_out
            /opt/jadx/bin/jadx "app.apk" -d jadx_out || echo "âš ï¸ Error al decompilar con JADX"

      - run:
          name: ðŸ”Ž AnÃ¡lisis rÃ¡pido (Manifest + Smali)
          command: |
            echo "ðŸ“„ Resumen del anÃ¡lisis de 'app.apk'" > resumen_avanzado.txt
            echo -e "\nðŸ” Permisos crÃ­ticos:" >> resumen_avanzado.txt
            grep -i "uses-permission" jadx_out/resources/AndroidManifest.xml | \
            grep -Ei "INTERNET|SMS|CONTACTS|CALL|CAMERA|LOCATION|AUDIO|STORAGE" >> resumen_avanzado.txt || echo "âœ”ï¸ NingÃºn permiso crÃ­tico detectado" >> resumen_avanzado.txt
            echo -e "\nâš ï¸ Flags inseguras:" >> resumen_avanzado.txt
            grep -iE "android:debuggable|allowBackup|usesCleartextTraffic" jadx_out/resources/AndroidManifest.xml >> resumen_avanzado.txt || echo "âœ”ï¸ Flags seguras" >> resumen_avanzado.txt
            echo -e "\nðŸŒ URLs encontradas:" >> resumen_avanzado.txt
            grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' jadx_out/ | sort -u >> resumen_avanzado.txt || echo "âœ”ï¸ No se detectaron URLs" >> resumen_avanzado.txt

      - run:
          name: ðŸ›¡ï¸ AnÃ¡lisis Semgrep
          command: |
            echo -e "\nðŸ›¡ï¸ Semgrep (p/mobsfscan):" >> resumen_avanzado.txt
            semgrep --quiet --config=p/mobsfscan jadx_out --json > semgrep.json || true
            jq -r '.results[]? | .path + ": " + .extra.message' semgrep.json >> resumen_avanzado.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_avanzado.txt

      - run:
          name: ðŸ“± AnÃ¡lisis MobSFScan
          command: |
            echo -e "\nðŸ“± MobSFScan:" >> resumen_avanzado.txt
            mobsfscan jadx_out --json > mobsfscan.json || true
            jq -r '.results[]? | .file_path + ": " + .title' mobsfscan.json >> resumen_avanzado.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_avanzado.txt

      - run:
          name: ðŸ“„ Mostrar resumen
          command: |
            echo -e "\nðŸ“‹ RESUMEN FINAL:"
            cat resumen_avanzado.txt

      - store_artifacts:
          path: resumen_avanzado.txt
          destination: resumen_avanzado.txt
      - store_artifacts:
          path: semgrep.json
          destination: semgrep.json
      - store_artifacts:
          path: mobsfscan.json
          destination: mobsfscan.json

workflows:
  version: 2
  analisis_apk:
    jobs:
      - analisis_completo
