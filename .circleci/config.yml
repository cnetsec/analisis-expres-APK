version: 2.1

orbs:
  python: circleci/python@2.3.0

jobs:
  analisis_completo:
    docker:
      - image: cimg/base:stable
    parameters:
      apk_name:
        type: string
        default: "app.apk"
    steps:
      - checkout

      - run:
          name: ğŸ“‚ Verificar existencia del APK
          command: |
            echo "ğŸ” Buscando el archivo APK '<< parameters.apk_name >>'..."
            if [ ! -f "<< parameters.apk_name >>" ]; then
              echo "âŒ APK no encontrado en el repositorio."
              exit 1
            fi
            echo "âœ… APK '<< parameters.apk_name >>' encontrado."

      - run:
          name: ğŸ›  Instalar dependencias
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y -qq openjdk-17-jdk unzip wget python3 python3-pip jq git
            wget -q https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
            unzip -o jadx-1.4.7.zip -d /opt/jadx
            pip3 install --quiet semgrep mobsfscan

      - run:
          name: ğŸ§© Decompilar APK (JADX)
          command: |
            echo "ğŸ§© Decompilando el APK..."
            mkdir -p jadx_out
            /opt/jadx/bin/jadx "<< parameters.apk_name >>" -d jadx_out || echo "âš ï¸ Error al decompilar con JADX"

      - run:
          name: ğŸ” AnÃ¡lisis rÃ¡pido (Manifest + Smali)
          command: |
            echo "ğŸ“„ Resumen del anÃ¡lisis de '<< parameters.apk_name >>'" > resumen_avanzado.txt
            echo -e "\nğŸ” Permisos crÃ­ticos:" >> resumen_avanzado.txt
            grep -i "uses-permission" jadx_out/resources/AndroidManifest.xml | \
            grep -Ei "INTERNET|SMS|CONTACTS|CALL|CAMERA|LOCATION|AUDIO|STORAGE" >> resumen_avanzado.txt || echo "âœ”ï¸ NingÃºn permiso crÃ­tico detectado" >> resumen_avanzado.txt
            echo -e "\nâš ï¸ Flags inseguras:" >> resumen_avanzado.txt
            grep -iE "android:debuggable|allowBackup|usesCleartextTraffic" jadx_out/resources/AndroidManifest.xml >> resumen_avanzado.txt || echo "âœ”ï¸ Flags seguras" >> resumen_avanzado.txt
            echo -e "\nğŸŒ URLs encontradas:" >> resumen_avanzado.txt
            grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' jadx_out/ | sort -u >> resumen_avanzado.txt || echo "âœ”ï¸ No se detectaron URLs" >> resumen_avanzado.txt

      - run:
          name: ğŸ›¡ï¸ AnÃ¡lisis Semgrep
          command: |
            echo -e "\nğŸ›¡ï¸ Semgrep (p/mobsfscan):" >> resumen_avanzado.txt
            semgrep --quiet --config=p/mobsfscan jadx_out --json > semgrep.json || true
            jq -r '.results[]? | .path + ": " + .extra.message' semgrep.json >> resumen_avanzado.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_avanzado.txt

      - run:
          name: ğŸ“± AnÃ¡lisis MobSFScan
          command: |
            echo -e "\nğŸ“± MobSFScan:" >> resumen_avanzado.txt
            mobsfscan jadx_out --json > mobsfscan.json || true
            jq -r '.results[]? | .file_path + ": " + .title' mobsfscan.json >> resumen_avanzado.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_avanzado.txt

      - run:
          name: ğŸ“„ Mostrar resumen
          command: |
            echo -e "\nğŸ“‹ RESUMEN FINAL:"
            cat resumen_avanzado.txt

      - persist_to_workspace:
          root: .
          paths:
            - resumen_avanzado.txt
            - semgrep.json
            - mobsfscan.json

workflows:
  version: 2
  analisis_apk:
    jobs:
      - analisis_completo:
          apk_name: "app.apk"
