name: ðŸ“± AnÃ¡lisis APK Completo

on:
  workflow_dispatch:
    inputs:
      apk_name:
        description: 'ðŸ—‚ï¸ Nombre del archivo APK (ej: app.apk)'
        required: true
        default: 'app.apk'
        type: string

jobs:
  analisis_apk:
    name: ðŸ” AnÃ¡lisis completo del APK
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar dependencias necesarias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y apktool openjdk-17-jdk wget unzip grep python3 python3-pip jq
          wget -q https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip
          mkdir -p $HOME/jadx
          unzip -o jadx-1.4.7.zip -d $HOME/jadx
          pip3 install --no-cache-dir semgrep mobsfscan

      - name: ðŸ“¦ Preparar entorno
        run: mkdir -p decompilado jadx_out

      - name: ðŸ› ï¸ Decompilar APK con Apktool
        run: |
          apktool d "${{ inputs.apk_name }}" -o decompilado -f

      - name: ðŸ§© Decompilar APK con JADX
        run: |
          $HOME/jadx/bin/jadx "${{ inputs.apk_name }}" -d jadx_out || echo "âš ï¸ Error al decompilar con JADX"

      - name: ðŸ§ª Iniciar resumen de anÃ¡lisis
        run: |
          echo "ðŸ“„ Resumen del anÃ¡lisis de '${{ inputs.apk_name }}'" > resumen_apk.txt

      # --- Greps OWASP Mobile Top 10 ---
      - name: ðŸ” Permisos peligrosos
        run: |
          echo -e "\nðŸ” Permisos peligrosos:" >> resumen_apk.txt
          grep -i "uses-permission" decompilado/AndroidManifest.xml | \
          grep -Ei "INTERNET|SMS|READ_CONTACTS|CALL|CAMERA|RECORD_AUDIO|WRITE_EXTERNAL_STORAGE|READ_EXTERNAL_STORAGE|ACCESS_FINE_LOCATION" >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron permisos crÃ­ticos" >> resumen_apk.txt

      - name: âš ï¸ Flags de seguridad
        run: |
          echo -e "\nâš ï¸ Flags de seguridad:" >> resumen_apk.txt
          grep -iE "android:debuggable|allowBackup|usesCleartextTraffic" decompilado/AndroidManifest.xml >> resumen_apk.txt || echo "âœ”ï¸ No se encontraron flags inseguras" >> resumen_apk.txt

      - name: ðŸŒ URLs encontradas
        run: |
          echo -e "\nðŸŒ URLs encontradas:" >> resumen_apk.txt
          grep -IorE 'https?://[a-zA-Z0-9./?=_\-]+' decompilado/ | sort -u >> resumen_apk.txt || echo "âœ”ï¸ No se encontraron URLs" >> resumen_apk.txt

      - name: ðŸ”‘ BÃºsqueda de claves/API Keys
        run: |
          echo -e "\nðŸ”‘ Claves/API Keys potenciales:" >> resumen_apk.txt
          grep -IorE "(api_key|secret|token|password) ?= ?['\"]?[a-zA-Z0-9_\-]+" jadx_out/ >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron claves" >> resumen_apk.txt

      - name: ðŸ§® CriptografÃ­a insegura
        run: |
          echo -e "\nðŸ§® Uso de criptografÃ­a insegura:" >> resumen_apk.txt
          grep -IorE "MD5|DES|AES/ECB|RC4" jadx_out/ >> resumen_apk.txt || echo "âœ”ï¸ No se detectÃ³ criptografÃ­a insegura" >> resumen_apk.txt

      - name: ðŸ“¤ Componentes exportados
        run: |
          echo -e "\nðŸ“¤ Componentes exportados:" >> resumen_apk.txt
          grep -i "android:exported=\"true\"" decompilado/AndroidManifest.xml >> resumen_apk.txt || echo "âœ”ï¸ NingÃºn componente exportado detectado" >> resumen_apk.txt

      - name: ðŸŒ WebView inseguro
        run: |
          echo -e "\nðŸŒ Uso inseguro de WebView:" >> resumen_apk.txt
          grep -IorE "setJavaScriptEnabled|addJavascriptInterface" jadx_out/ >> resumen_apk.txt || echo "âœ”ï¸ No se detectÃ³ uso inseguro de WebView" >> resumen_apk.txt

      - name: ðŸªµ Logs sensibles
        run: |
          echo -e "\nðŸªµ Uso de logs sensibles:" >> resumen_apk.txt
          grep -IorE "Log\.d|Log\.v|printStackTrace" jadx_out/ >> resumen_apk.txt || echo "âœ”ï¸ No se detectÃ³ logging sensible" >> resumen_apk.txt

      - name: ðŸ”’ Certificados inseguros
        run: |
          echo -e "\nðŸ”’ Uso de certificados inseguros:" >> resumen_apk.txt
          grep -IorE "TrustAllCerts|HostnameVerifier" jadx_out/ >> resumen_apk.txt || echo "âœ”ï¸ No se detectaron certificados inseguros" >> resumen_apk.txt

      # --- Semgrep y MobSFScan ---
      - name: ðŸ›¡ï¸ AnÃ¡lisis Semgrep
        run: |
          echo -e "\nðŸ›¡ï¸ Semgrep (p/mobsfscan):" >> resumen_apk.txt
          semgrep --quiet --config=p/mobsfscan jadx_out --json > semgrep.json || true
          jq -r '.results[]? | .path + ": " + .extra.message' semgrep.json >> resumen_apk.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_apk.txt

      - name: ðŸ“± AnÃ¡lisis MobSFScan
        run: |
          echo -e "\nðŸ“± MobSFScan:" >> resumen_apk.txt
          mobsfscan jadx_out --json > mobsfscan.json || true
          jq -r '.results[]? | .file_path + ": " + .title' mobsfscan.json >> resumen_apk.txt || echo "âœ”ï¸ Sin hallazgos relevantes" >> resumen_apk.txt

      - name: ðŸ“„ Mostrar resumen
        run: |
          echo -e "\nðŸ“‹ RESUMEN FINAL:"
          cat resumen_apk.txt

      - name: ðŸ’¾ Subir artefacto de resultados
        uses: actions/upload-artifact@v4
        with:
          name: analisis-apk-completo
          path: |
            resumen_apk.txt
            semgrep.json
            mobsfscan.json
